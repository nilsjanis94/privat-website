<div class="shopping-list-container">
  
  <!-- Header mit Statistiken -->
  <div class="header-stats">
    <mat-card class="stats-card" [ngClass]="(currentTheme$ | async) + '-theme'">
      <mat-card-content>
        <div class="stats-grid">
          <div class="stat-item">
            <mat-icon>shopping_cart</mat-icon>
            <div class="stat-content">
              <span class="stat-number">{{ totalItems }}</span>
              <span class="stat-label">Vorschl√§ge</span>
            </div>
          </div>
          <div class="stat-item">
            <mat-icon>priority_high</mat-icon>
            <div class="stat-content">
              <span class="stat-number">{{ highPriorityCount }}</span>
              <span class="stat-label">Hohe Priorit√§t</span>
            </div>
          </div>
          <div class="stat-item">
            <mat-icon>euro</mat-icon>
            <div class="stat-content">
              <span class="stat-number">{{ estimatedCost | currency:'EUR':'symbol':'1.0-2' }}</span>
              <span class="stat-label">Gesch√§tzte Kosten</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Tab Navigation -->
  <mat-tab-group class="shopping-tabs" mat-align-tabs="center">
    
    <!-- Smart Vorschl√§ge Tab -->
    <mat-tab label="üß† Smart Vorschl√§ge">
      <div class="tab-content">
        
        <!-- Loading Spinner -->
        <div *ngIf="loading" class="loading-container">
          <mat-progress-spinner 
            mode="indeterminate" 
            diameter="60"
            color="accent">
          </mat-progress-spinner>
          <p>Analysiere deine Verbrauchsmuster...</p>
        </div>

        <!-- Smart Suggestions List -->
        <div *ngIf="!loading && smartSuggestions.length > 0" class="suggestions-container">
          <div class="suggestions-header">
            <h3>üéØ Intelligente Wiederkauf-Vorschl√§ge</h3>
            <p class="suggestions-subtitle">Basierend auf deinen letzten Verbrauchsdaten</p>
          </div>

          <div class="suggestions-grid">
            <mat-card 
              *ngFor="let item of smartSuggestions" 
              class="suggestion-card"
              [class.selected]="item.is_selected"
              (click)="toggleItemSelection(item)">
              
              <mat-card-header>
                <div mat-card-avatar class="item-avatar">
                  <img *ngIf="item.image_url; else iconAvatar" 
                       [src]="item.image_url" 
                       [alt]="item.name"
                       class="product-avatar-image"
                       loading="lazy">
                  <ng-template #iconAvatar>
                    <mat-icon [color]="getPriorityColor(item.priority_score)">
                      {{ getPriorityIcon(item.priority_score) }}
                    </mat-icon>
                  </ng-template>
                </div>
                <mat-card-title>{{ item.name }}</mat-card-title>
                <mat-card-subtitle>{{ item.category }} ‚Ä¢ Empfohlen: {{ item.quantity_needed }}x</mat-card-subtitle>
                
                <div class="card-actions">
                  <mat-checkbox 
                    [checked]="item.is_selected"
                    (click)="$event.stopPropagation()"
                    (change)="toggleItemSelection(item)">
                  </mat-checkbox>
                </div>
              </mat-card-header>

              <mat-card-content>
                <div class="suggestion-details">
                  <div class="detail-row">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ item.suggestion_reason }}</span>
                  </div>
                  
                  <div class="detail-row" *ngIf="item.average_consumption_quantity > 1">
                    <mat-icon>bar_chart</mat-icon>
                    <span>√ò Verbrauch: {{ item.average_consumption_quantity | number:'1.1-1' }}x pro Kauf</span>
                  </div>
                  
                  <div class="detail-row" *ngIf="item.last_purchase_price > 0">
                    <mat-icon>euro</mat-icon>
                    <span>Letzter Preis: {{ item.last_purchase_price | currency:'EUR':'symbol':'1.0-2' }}</span>
                  </div>
                  
                  <div class="detail-row" *ngIf="item.purchase_frequency > 1">
                    <mat-icon>repeat</mat-icon>
                    <span>{{ item.purchase_frequency }}x gekauft</span>
                  </div>
                </div>

                <!-- Priority Score -->
                <div class="priority-score">
                  <mat-chip-listbox>
                    <mat-chip [color]="getPriorityColor(item.priority_score)" selected>
                      Priorit√§t: {{ item.priority_score }}
                    </mat-chip>
                  </mat-chip-listbox>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <!-- No Suggestions State -->
        <div *ngIf="!loading && smartSuggestions.length === 0" class="empty-state">
          <mat-icon class="empty-icon">smart_toy</mat-icon>
          <h3>Noch keine intelligenten Vorschl√§ge</h3>
          <p>Nutze das Inventar-System eine Weile, damit wir deine Verbrauchsmuster lernen k√∂nnen.</p>
          <button mat-raised-button color="primary" routerLink="/inventory">
            <mat-icon>inventory</mat-icon>
            Zum Inventar
          </button>
        </div>
      </div>
    </mat-tab>

    <!-- Manuelle Items Tab -->
    <mat-tab label="üìù Eigene Liste">
      <div class="tab-content">
        
        <!-- Add Manual Item Form -->
        <mat-card class="add-item-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>add_shopping_cart</mat-icon>
              Artikel hinzuf√ºgen
            </mat-card-title>
          </mat-card-header>
          
          <mat-card-content>
            <div class="add-item-form">
              <div class="form-row">
                <mat-form-field appearance="outline" class="item-name-field">
                  <mat-label>Artikel-Name *</mat-label>
                  <input matInput 
                         [(ngModel)]="newItemName" 
                         placeholder="z.B. Milch, Brot, Shampoo"
                         (keyup.enter)="addManualItem()">
                  <mat-icon matSuffix>label</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="quantity-field">
                  <mat-label>Anzahl</mat-label>
                  <input matInput 
                         type="number" 
                         [(ngModel)]="newItemQuantity" 
                         min="1" 
                         max="99">
                  <mat-icon matSuffix>inventory_2</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="category-field">
                  <mat-label>Kategorie</mat-label>
                  <input matInput 
                         [(ngModel)]="newItemCategory" 
                         placeholder="z.B. Lebensmittel, Drogerie">
                  <mat-icon matSuffix>category</mat-icon>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="store-field">
                  <mat-label>Laden</mat-label>
                  <input matInput 
                         [(ngModel)]="newItemStore" 
                         [matAutocomplete]="storeAuto"
                         placeholder="z.B. REWE, dm, LIDL">
                  <mat-icon matSuffix>store</mat-icon>
                  <mat-autocomplete #storeAuto="matAutocomplete">
                    <mat-option *ngFor="let store of commonStores" [value]="store">
                      {{ store }}
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Notizen (optional)</mat-label>
                  <textarea matInput 
                            [(ngModel)]="newItemNotes" 
                            rows="2"
                            placeholder="z.B. Bio, bestimmte Marke, Gr√∂√üe...">
                  </textarea>
                  <mat-icon matSuffix>note</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button mat-raised-button 
                        color="primary" 
                        (click)="addManualItem()"
                        [disabled]="!newItemName.trim()">
                  <mat-icon>add</mat-icon>
                  Hinzuf√ºgen
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Manual Items List -->
        <div *ngIf="manualItems.length > 0" class="manual-items-container">
          <h3>üìã Deine Einkaufsliste</h3>
          
          <div class="manual-items-list">
            <mat-card *ngFor="let item of manualItems; let i = index" class="manual-item-card">
              <mat-card-content>
                <div class="manual-item-content">
                  <div class="item-info">
                    <div class="item-header">
                      <h4>{{ item.name }}</h4>
                      <mat-chip color="accent">{{ item.quantity }}x</mat-chip>
                    </div>
                    <div class="item-details">
                      <span class="category">{{ item.category }}</span>
                      <span *ngIf="item.notes" class="notes">{{ item.notes }}</span>
                    </div>
                  </div>
                  
                  <div class="item-actions">
                    <button mat-icon-button 
                            color="warn" 
                            (click)="removeManualItem(i)"
                            matTooltip="Entfernen">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <!-- Empty Manual Items State -->
        <div *ngIf="manualItems.length === 0" class="empty-state">
          <mat-icon class="empty-icon">edit_note</mat-icon>
          <h3>Deine eigene Einkaufsliste ist leer</h3>
          <p>F√ºge Artikel hinzu, die du gerne kaufen m√∂chtest.</p>
        </div>
      </div>
    </mat-tab>

    <!-- Einkaufsmodus Tab -->
    <mat-tab label="üõí Einkaufen">
      <div class="tab-content">
        
        <!-- Nicht-aktiver Einkaufsmodus: √úbersicht der ausgew√§hlten Artikel -->
        <div *ngIf="!isShoppingActive" class="shopping-mode-container" [ngClass]="(currentTheme$ | async) + '-theme'">
          <div class="shopping-summary">
            <h3>üõí Einkaufsmodus</h3>
            <p>Hier siehst du alle ausgew√§hlten Artikel:</p>
            
            <!-- Selected Items Summary -->
            <div *ngIf="selectedItems.length > 0" class="selected-summary">
              <h4>Smart Vorschl√§ge ({{ selectedItems.length }})</h4>
              <div class="selected-items">
                <mat-chip-listbox>
                  <mat-chip *ngFor="let item of selectedItems">
                    {{ item.name }}
                  </mat-chip>
                </mat-chip-listbox>
              </div>
            </div>

            <div *ngIf="manualItems.length > 0" class="manual-summary">
              <h4>Eigene Liste ({{ manualItems.length }})</h4>
              <div class="manual-items">
                <mat-chip-listbox>
                  <mat-chip *ngFor="let item of manualItems">
                    {{ item.name }} ({{ item.quantity }}x)
                  </mat-chip>
                </mat-chip-listbox>
              </div>
            </div>
            
            <!-- Shopping Actions -->
            <div class="shopping-actions">
              <button mat-raised-button 
                      color="primary" 
                      size="large"
                      (click)="startShopping()"
                      [disabled]="selectedItems.length === 0 && manualItems.length === 0">
                <mat-icon>shopping_cart</mat-icon>
                Einkauf starten
              </button>
            </div>
          </div>
        </div>

        <!-- Aktiver Einkaufsmodus: Interaktive Einkaufsliste -->
        <div *ngIf="isShoppingActive" class="active-shopping-container">
          
          <!-- Shopping Header mit Progress -->
          <div class="shopping-header">
            <mat-card class="shopping-progress-card">
              <mat-card-header>
                <div mat-card-avatar class="shopping-avatar">
                  <mat-icon color="primary">shopping_cart</mat-icon>
                </div>
                <mat-card-title>Aktiver Einkauf</mat-card-title>
                <mat-card-subtitle>
                  {{ getShoppingProgress().completed }} von {{ getShoppingProgress().total }} Artikel
                </mat-card-subtitle>
              </mat-card-header>
              
              <mat-card-content>
                <!-- Progress Bar -->
                <div class="progress-info">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getShoppingProgress().percentage"></div>
                  </div>
                  <span class="progress-text">{{ getShoppingProgress().percentage }}%</span>
                </div>
                
                <!-- Cost Overview -->
                <div class="cost-overview">
                  <div class="cost-item">
                    <span class="cost-label">Geplant:</span>
                    <span class="cost-value">{{ currentShoppingSession?.total_planned_cost | currency:'EUR':'symbol':'1.0-2' }}</span>
                  </div>
                  <div class="cost-item">
                    <span class="cost-label">Tats√§chlich:</span>
                    <span class="cost-value actual">{{ currentShoppingSession?.total_actual_cost | currency:'EUR':'symbol':'1.0-2' }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Shopping Items List -->
          <div class="shopping-items-container">
            <h3>üè™ Einkauf nach L√§den organisiert</h3>
            
            <!-- Gruppierung nach L√§den -->
            <div class="shopping-stores-container">
              <div *ngFor="let store of getSortedStoreNames()" class="store-group">
                <mat-card class="store-header-card">
                  <mat-card-header>
                    <div mat-card-avatar class="store-avatar">
                      <mat-icon color="primary">store</mat-icon>
                    </div>
                    <mat-card-title>üè™ {{ store }}</mat-card-title>
                    <mat-card-subtitle>
                      {{ getStoreStats(store).purchased }} von {{ getStoreStats(store).total }} Artikel ({{ getStoreStats(store).percentage }}%)
                    </mat-card-subtitle>
                  </mat-card-header>
                  
                  <mat-card-content>
                    <div class="store-progress">
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="getStoreStats(store).percentage"></div>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Items f√ºr diesen Store -->
                <div class="store-items-list">
                  <mat-card 
                    *ngFor="let item of getItemsByStore()[store]" 
                    class="shopping-item-card"
                    [class.purchased]="item.is_purchased">
                    
                    <mat-card-content>
                      <div class="shopping-item-content">
                        
                        <!-- Checkbox und Item Info -->
                        <div class="item-main">
                          <mat-checkbox 
                            [checked]="item.is_purchased"
                            (change)="toggleItemPurchased(item)"
                            class="purchase-checkbox">
                          </mat-checkbox>
                          
                          <div class="item-details">
                            <div class="item-header">
                              <div class="item-title-row">
                                <h4 [class.strikethrough]="item.is_purchased">{{ item.name }}</h4>
                                <div *ngIf="getItemImageUrl(item)" class="item-thumbnail">
                                  <img [src]="getItemImageUrl(item)" 
                                       [alt]="item.name"
                                       class="shopping-item-image"
                                       loading="lazy">
                                </div>
                              </div>
                              <div class="item-meta">
                                <mat-chip class="category-chip">{{ item.category }}</mat-chip>
                                <mat-chip class="source-chip" [color]="item.source === 'smart' ? 'primary' : 'accent'">
                                  {{ item.source === 'smart' ? 'üß†' : 'üìù' }}
                                </mat-chip>
                              </div>
                            </div>
                            <p *ngIf="item.notes" class="item-notes">{{ item.notes }}</p>
                          </div>
                        </div>

                        <!-- Quantity und Price Controls -->
                        <div class="item-controls">
                          <div class="quantity-control">
                            <mat-form-field appearance="outline" class="quantity-field">
                              <mat-label>Anzahl</mat-label>
                              <input matInput 
                                     type="number" 
                                     [(ngModel)]="item.purchased_quantity"
                                     (ngModelChange)="updateItemQuantity(item, $event)"
                                     min="0" 
                                     max="99"
                                     [disabled]="!item.is_purchased">
                              <span matSuffix>/ {{ item.planned_quantity }}</span>
                            </mat-form-field>
                          </div>
                          
                          <div class="price-control">
                            <mat-form-field appearance="outline" class="price-field">
                              <mat-label>Preis</mat-label>
                              <input matInput 
                                     type="number" 
                                     [(ngModel)]="item.actual_price"
                                     (ngModelChange)="updateItemPrice(item, $event)"
                                     min="0" 
                                     step="0.01"
                                     placeholder="0.00"
                                     [disabled]="!item.is_purchased">
                              <span matPrefix>‚Ç¨&nbsp;</span>
                              <span matSuffix *ngIf="item.planned_price">({{ item.planned_price | currency:'EUR':'symbol':'1.0-2' }})</span>
                            </mat-form-field>
                          </div>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
            </div>
          </div>

          <!-- Shopping Actions -->
          <div class="shopping-actions-bottom">
            <div class="action-buttons">
              <button mat-raised-button 
                      color="warn"
                      (click)="cancelShoppingSession()"
                      class="cancel-btn">
                <mat-icon>cancel</mat-icon>
                Abbrechen
              </button>
              
              <button mat-raised-button 
                      color="primary"
                      (click)="completeShoppingSession()"
                      [disabled]="getShoppingProgress().completed === 0 || loading"
                      class="complete-btn">
                <mat-icon>check_circle</mat-icon>
                <span *ngIf="!loading">Einkauf abschlie√üen</span>
                <span *ngIf="loading">Verarbeite...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div> 